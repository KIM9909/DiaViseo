stages:
  - approval-check

check_approvals:
  stage: approval-check
  image: curlimages/curl:latest
  before_script:
    - apk add --no-cache jq
  script:
    - RESPONSE=$(curl --silent --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/approvals")
    - APPROVED=$(echo "$RESPONSE" | jq '.approved_by | length')
    - |
      if [ "$APPROVED" -lt 2 ]; then
        echo "ERROR: 최소 2개의 승인이 필요합니다. 현재 승인 수: $APPROVED"
        exit 1
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
